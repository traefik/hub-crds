name: üèóÔ∏è Template for Update CRDs on Go project
on:
  workflow_call:
    inputs:
      TARGET_REPO:
        required: true
        type: string
      TARGET_BRANCH:
        required: true
        type: string
      CRDS_VERSION:
        required: true
        type: string
jobs:
  update-crds:
    runs-on: ubuntu-latest
    steps:
      - name: checkout target repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          repository: ${{ inputs.TARGET_REPO }}
          ref: ${{ inputs.TARGET_BRANCH }}
          token: ${{ secrets.GH_TOKEN }}
      - name: set up Go 1.x
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: 'go.mod'
      - name: setup proxy credentials
        run: |
          cat <<EOF > ~/.netrc
          ${{secrets.GOPROXY_CREDS}}
          EOF
      - name: update go.mod
        env:
          GONOSUMDB: github.com/traefik/hub-crds
          GOPROXY: https://proxy.golang.org,https://athens.traefiklabs.tech,direct
        run: |
          sed -i -e "s|github.com/traefik/hub-crds .*|github.com/traefik/hub-crds ${{ inputs.CRDS_VERSION }}|g" go.mod
          go mod tidy
      - name: create PR
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6.1.0
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "chore: update CRDs to ${{ inputs.CRDS_VERSION }}"
          committer: "Traefiker <traefiker@github.com>"
          author: "${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
          signoff: false
          branch: update-crds-${{ inputs.CRDS_VERSION }}
          delete-branch: true
          title: 'chore: update CRDs to ${{ inputs.CRDS_VERSION }}'
          labels: kind/enhancement,status/2-needs-review
          body: |
            This PR was automatically created by ${{ github.workflow }} workflow on run [#${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).

            This was triggered by commit [${{ github.ref }}](https://github.com/${{ github.repository }}/commits/${{ github.sha }}) on [${{ github.repository }}](https://github.com/${{ github.repository }}).
